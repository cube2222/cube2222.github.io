<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Web app using Microservices in Go: Part 4 – Worker and Frontend | Jacob Martin</title>
<meta name=keywords content="architecture,design,frontend,go,golang,microservice,tutorial,worker"><meta name=description content="Previous part
Introduction In this part we will finally finish writing our application. We will implement the last two services:
The Worker The Frontend The Worker The worker will communicate with the Master to get new Tasks. When it gets a Task it will get the corresponding data from the storage and will start working on the task. When it finishes it will send the finished data to the storage service, and if that succeeds it will register the Task as finished to the Master."><meta name=author content="Jacob Martin"><link rel=canonical href=https://kubamartin.com/2016/03/23/web-app-using-microservices-in-go-part-4-worker-and-frontend/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://kubamartin.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kubamartin.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kubamartin.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kubamartin.com/apple-touch-icon.png><link rel=mask-icon href=https://kubamartin.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kubamartin.com/2016/03/23/web-app-using-microservices-in-go-part-4-worker-and-frontend/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Web app using Microservices in Go: Part 4 – Worker and Frontend"><meta property="og:description" content="Previous part
Introduction In this part we will finally finish writing our application. We will implement the last two services:
The Worker The Frontend The Worker The worker will communicate with the Master to get new Tasks. When it gets a Task it will get the corresponding data from the storage and will start working on the task. When it finishes it will send the finished data to the storage service, and if that succeeds it will register the Task as finished to the Master."><meta property="og:type" content="article"><meta property="og:url" content="https://kubamartin.com/2016/03/23/web-app-using-microservices-in-go-part-4-worker-and-frontend/"><meta property="og:image" content="https://kubamartin.com/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-03-23T13:34:03+00:00"><meta property="article:modified_time" content="2016-03-23T13:34:03+00:00"><meta property="og:site_name" content="Jacob Martin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kubamartin.com/images/avatar.jpg"><meta name=twitter:title content="Web app using Microservices in Go: Part 4 – Worker and Frontend"><meta name=twitter:description content="Previous part
Introduction In this part we will finally finish writing our application. We will implement the last two services:
The Worker The Frontend The Worker The worker will communicate with the Master to get new Tasks. When it gets a Task it will get the corresponding data from the storage and will start working on the task. When it finishes it will send the finished data to the storage service, and if that succeeds it will register the Task as finished to the Master."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kubamartin.com/posts/"},{"@type":"ListItem","position":2,"name":"Web app using Microservices in Go: Part 4 – Worker and Frontend","item":"https://kubamartin.com/2016/03/23/web-app-using-microservices-in-go-part-4-worker-and-frontend/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Web app using Microservices in Go: Part 4 – Worker and Frontend","name":"Web app using Microservices in Go: Part 4 – Worker and Frontend","description":"Previous part\nIntroduction In this part we will finally finish writing our application. We will implement the last two services:\nThe Worker The Frontend The Worker The worker will communicate with the Master to get new Tasks. When it gets a Task it will get the corresponding data from the storage and will start working on the task. When it finishes it will send the finished data to the storage service, and if that succeeds it will register the Task as finished to the Master.","keywords":["architecture","design","frontend","go","golang","microservice","tutorial","worker"],"articleBody":"Previous part\nIntroduction In this part we will finally finish writing our application. We will implement the last two services:\nThe Worker The Frontend The Worker The worker will communicate with the Master to get new Tasks. When it gets a Task it will get the corresponding data from the storage and will start working on the task. When it finishes it will send the finished data to the storage service, and if that succeeds it will register the Task as finished to the Master.\nThat means that you can easily scale the workforce, by turning on additional machines, with the worker service on them. Easy scaling is good!\nImplementation As usual we will start with a basic structure which is similar to the structure of our previous services. Although there is one big difference. There won’t be any API here as the worker will be a client. You could, if you wanted, add an API for debugging purposes. Things like getting the processor usage. But this can also be implemented using 3rd party health checking services.\nSo here’s our basic structure:\npackage main import ( \"os\" \"fmt\" \"net/http\" \"io/ioutil\" \"encoding/json\" \"time\" \"strconv\" \"image\" \"image/png\" \"image/color\" \"bytes\" \"sync\" ) type Task struct { Id int `json:\"id\"` State int `json:\"state\"` } var masterLocation string var storageLocation string var keyValueStoreAddress string func main() { if len(os.Args) \u003c 3 { fmt.Println(\"Error: Too few arguments.\") return } keyValueStoreAddress = os.Args[1] response, err := http.Get(\"http://\" + keyValueStoreAddress + \"/get?key=masterAddress\") if response.StatusCode != http.StatusOK { fmt.Println(\"Error: can't get master address.\") fmt.Println(response.Body) return } data, err := ioutil.ReadAll(response.Body) if err != nil { fmt.Println(err) return } masterLocation = string(data) if len(masterLocation) == 0 { fmt.Println(\"Error: can't get master address. Length is zero.\") return } response, err = http.Get(\"http://\" + keyValueStoreAddress + \"/get?key=storageAddress\") if response.StatusCode != http.StatusOK { fmt.Println(\"Error: can't get storage address.\") fmt.Println(response.Body) return } data, err = ioutil.ReadAll(response.Body) if err != nil { fmt.Println(err) return } storageLocation = string(data) if len(storageLocation) == 0 { fmt.Println(\"Error: can't get storage address. Length is zero.\") return } } func getNewTask(masterAddress string) (Task, error) { } func getImageFromStorage(storageAddress string, myTask Task) (image.Image, error) { } func doWorkOnImage(myImage image.Image) image.Image { } func sendImageToStorage(storageAddress string, myTask Task, myImage image.Image) error { } func registerFinishedTask(masterAddress string, myTask Task) error { } It may seem to be much but there is nothing new actually in the most dense parts. We define the Task structure first and declare the needed addresses/locations.\nLater we check if there are enough arguments passed to the application, and, as we did in the previous parts, we get the addresses of the Master and the Storage. That’s basically all.\nFor the worker we will want a command line parameter to set the number of concurrent threads. That’s why we check if there are 3 Arguments.\nNow let’s parse the thread count:\nstorageLocation = string(data) if len(storageLocation) == 0 { fmt.Println(\"Error: can't get storage address. Length is zero.\") return } threadCount, err := strconv.Atoi(os.Args[2]) if err != nil { fmt.Println(\"Error: Couldn't parse thread count.\") return } We use the atoi function to parse the string argument to an int.\nAnd now we come to the main for loop which runs on each thread:\nmyWG := sync.WaitGroup{} myWG.Add(threadCount) for i := 0; i \u003c threadCount; i++ { go func() { for { //Do work... } }() } myWG.Wait() Ok, what are we doing there? We create a waitGroup. The main function has to be waiting for the goroutines and not just finish execution, that’s why we create a waitGroup and add the thread count. You could add a functionality to break the endless for loop and after that use the Done() function on the waitgroup. We won’t be adding this as we just want endless for work loops.\nNow we will write down the execution process for each Task.\nFirst we get a new Task:\nfor { myTask, err := getNewTask(masterLocation) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } If we error, then we wait 2 seconds, so it doesn’t make a lot of errored requests to the master at once. As this could flood the other services.\nIf we successfully get the Task, then we get the image to work on from the storage:\nmyTask, err := getNewTask(masterLocation) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } myImage, err := getImageFromStorage(storageLocation, myTask) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } Ok, now it’s time to do something with the image!!!\nmyImage, err := getImageFromStorage(storageLocation, myTask) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } myImage = doWorkOnImage(myImage) We now of course have to save the image back to the storage:\nmyImage = doWorkOnImage(myImage) err = sendImageToStorage(storageLocation, myTask, myImage) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } And finally if that succeeds we register our successfully finished Task!\nerr = sendImageToStorage(storageLocation, myTask, myImage) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } err = registerFinishedTask(masterLocation, myTask) if err != nil { fmt.Println(err) fmt.Println(\"Waiting 2 second timeout...\") time.Sleep(time.Second * 2) continue } } }() Ok, so now we can continue with implementing these functions. Let’s first implement the getNewTask function:\nfunc getNewTask(masterAddress string) (Task, error) { response, err := http.Post(\"http://\" + masterAddress + \"/getNewTask\", \"text/plain\", nil) if err != nil || response.StatusCode != http.StatusOK { return Task{-1, -1}, err } data, err := ioutil.ReadAll(response.Body) if err != nil { return Task{-1, -1}, err } myTask := Task{} err = json.Unmarshal(data, \u0026myTask) if err != nil { return Task{-1, -1}, err } return myTask, nil } We make the request to the master and check if it was successful. We read the response body to memory and finally Unmarshal the response body to our Task structure. Finally we return it.\nNow we can implement the function to get the image from storage!\nfunc getImageFromStorage(storageAddress string, myTask Task) (image.Image, error) { response, err := http.Get(\"http://\" + storageAddress + \"/getImage?state=working\u0026id=\" + strconv.Itoa(myTask.Id)) if err != nil || response.StatusCode != http.StatusOK { return nil, err } myImage, err := png.Decode(response.Body) if err != nil { return nil, err } return myImage, nil } We get the response whose body is the raw image, so we just Decode it and return it if we succeed.\nNow that we have our image we can finally do some work on it:\nfunc doWorkOnImage(myImage image.Image) image.Image { myCanvas := image.NewRGBA(myImage.Bounds()) for i := 0; i \u003c myCanvas.Rect.Max.X; i++ { for j := 0; j \u003c myCanvas.Rect.Max.Y; j++ { r, g, b, _ := myImage.At(i, j).RGBA() myColor := new(color.RGBA) myColor.R = uint8(g) myColor.G = uint8(r) myColor.B = uint8(b) myColor.A = uint8(255) myCanvas.Set(i, j, myColor) } } return myCanvas.SubImage(myImage.Bounds()) } The work is largely irrelevant, but I’ll explain it anyways. First we create a RGBA. That’s something like a canvas for drawing, and we create it with the size of our image. Later we draw on the canvas swapping the red with the green channel. Later we use the RGBA to return a new modified image, created from our canvas with the size of our original image.\nAfter working on the image we have to send it back to the storage system. So let’s implement the sendImageToStorage function:\nfunc sendImageToStorage(storageAddress string, myTask Task, myImage image.Image) error { data := []byte{} buffer := bytes.NewBuffer(data) err := png.Encode(buffer, myImage) if err != nil { return err } response, err := http.Post(\"http://\" + storageAddress + \"/sendImage?state=finished\u0026id=\" + strconv.Itoa(myTask.Id), \"image/png\", buffer) if err != nil || response.StatusCode != http.StatusOK { return err } return nil } We create a data byte slice, and from that a data buffer which allows us to use it as a readwriter interface. We then use this interface to encode our image to png into, and finally send it using a POST to the server. If everything works out, then we just return.\nWhen we successfully saved the image, we can register to the Master that we finished the Task.\nfunc registerFinishedTask(masterAddress string, myTask Task) error { response, err := http.Post(\"http://\" + masterAddress + \"/registerTaskFinished?id=\" + strconv.Itoa(myTask.Id), \"test/plain\", nil) if err != nil || response.StatusCode != http.StatusOK { return err } return nil } Nothing fancy. Just sending a POST request to notify about finishing the task.\nOk, that’s all regarding the worker. You can turn it on and it will wait for Tasks to get. Which means we need to get the Tasks from the user to our service finally. And that leads us to…\nThe Frontend This one will show the user the website and also parse the user form so the backend services only get the raw image data. It will be the only interface to our application for the user.\nAs usual, we’ll begin with the basic structure of the file:\npackage main import ( \"net/http\" \"fmt\" \"io/ioutil\" \"os\" \"net/url\" \"io\" ) const indexPage = \"Upload file \" var keyValueStoreAddress string var masterLocation string func main() { if len(os.Args) \u003c 2 { fmt.Println(\"Error: Too few arguments.\") return } keyValueStoreAddress = os.Args[1] response, err := http.Get(\"http://\" + keyValueStoreAddress + \"/get?key=masterAddress\") if response.StatusCode != http.StatusOK { fmt.Println(\"Error: can't get master address.\") fmt.Println(response.Body) return } data, err := ioutil.ReadAll(response.Body) if err != nil { fmt.Println(err) return } masterLocation = string(data) if len(masterLocation) == 0 { fmt.Println(\"Error: can't get master address. Length is zero.\") return } http.HandleFunc(\"/\", handleIndex) http.HandleFunc(\"/submitTask\", handleTask) http.HandleFunc(\"/isReady\", handleCheckForReadiness) http.HandleFunc(\"/getImage\", serveImage) http.ListenAndServe(\":80\", nil) } func handleIndex(w http.ResponseWriter, r *http.Request) { } func handleTask(w http.ResponseWriter, r *http.Request) { } func handleCheckForReadiness(w http.ResponseWriter, r *http.Request) { } func serveImage(w http.ResponseWriter, r *http.Request) { } We’ve got the code of our index web page here, and we also have the API declared. After starting the program we check if we have the k/v store address. If we do (we hope so), then we can get the master address from it.\nNow we can go on to implementing the functions. We’ll start with the simples. The index handler:\nfunc handleIndex(w http.ResponseWriter, r *http.Request) { fmt.Fprint(w, indexPage) } After writing this we can go on to writing the more complicated functions. We will start with the handleTask function. This function is responsible for parsing the user form and sending the raw image data to the master.\nfunc handleTask(w http.ResponseWriter, r *http.Request) { if r.Method == http.MethodPost { err := r.ParseMultipartForm(10000000) if err != nil { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Wrong input\") return } file, _, err := r.FormFile(\"uploadfile\") if err != nil { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Wrong input\") return } Ok, what do we have here? We check the method as we always do, and later parse the multipart form. We’ve got a nice lovely magic number there. The number is responsible for setting the max size of the form held in RAM. The rest will be stored in temporary files. We later do the request using the file we got:\nif err != nil { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Wrong input\") return } response, err := http.Post(\"http://\" + masterLocation + \"/new\", \"image\", file) if err != nil || response.StatusCode != http.StatusOK { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error:\", err) return } data, err := ioutil.ReadAll(response.Body) if err != nil { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error:\", err) return } fmt.Fprint(w, string(data)) } else { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error: Only POST accepted\") } We send the user back the new Task id we got back from the master.\nNow we can implement the function which will handle the request to check if the Task is finished and ready:\nfunc handleCheckForReadiness(w http.ResponseWriter, r *http.Request) { if r.Method == http.MethodGet { values, err := url.ParseQuery(r.URL.RawQuery) if err != nil { fmt.Fprint(w, err) return } if len(values.Get(\"id\")) == 0 { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Wrong input\") return } response, err := http.Get(\"http://\" + masterLocation + \"/isReady?id=\" + values.Get(\"id\") + \"\u0026state=finished\") if err != nil || response.StatusCode != http.StatusOK { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error:\", err) return } data, err := ioutil.ReadAll(response.Body) if err != nil { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error:\", err) return } switch string(data) { case \"0\": fmt.Fprint(w, \"Your image is not ready yet.\") case \"1\": fmt.Fprint(w, \"Your image is ready.\") default : fmt.Fprint(w, \"Internal server error.\") } } else { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error: Only GET accepted\") } } Most of this is the same as the function in the master. We just check if the id is correct and make a request to the master. The interesting part is this:\nswitch string(data) { case \"0\": fmt.Fprint(w, \"Your image is not ready yet.\") case \"1\": fmt.Fprint(w, \"Your image is ready.\") default : fmt.Fprint(w, \"Internal server error.\") } We cast the response body to a string, and if it matches 1 or 0 we answer. If it’s something else then we know something went really wrong, and send back an error.\nNow we can get to the last function, the function to serve the actual images:\nfunc serveImage(w http.ResponseWriter, r *http.Request) { if r.Method == http.MethodGet { values, err := url.ParseQuery(r.URL.RawQuery) if err != nil { fmt.Fprint(w, err) return } if len(values.Get(\"id\")) == 0 { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Wrong input\") return } response, err := http.Get(\"http://\" + masterLocation + \"/get?id=\" + values.Get(\"id\") + \"\u0026state=finished\") if err != nil || response.StatusCode != http.StatusOK { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error:\", err) return } _, err = io.Copy(w, response.Body) if err != nil { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error:\", err) return } } else { w.WriteHeader(http.StatusBadRequest) fmt.Fprint(w, \"Error: Only GET accepted\") } } It just checks the id, sends the request, and copies the response to answer the user.\nConclusion So now it’s all finished. You can start all applications and they will work. You can contact the frontend and make requests, they will all start working and you will get your modified images. Six microservices working beautifully together.\nThis may be the end of this series, so have fun extending this system alone.\nI may add a finishing part about deployment to container infrastructues, or a another extending series about refactoring the system with 3rd party libraries in the future but I’m not sure.\nAll in all, good luck!\nUPDATE: Also remember, that when running the worker, it’s good to launch it with goroutines in the number of 2-4x your system threads. They have near-0 overhead in switching and this way your not unnecessarily blocking when waiting for http responses.\n","wordCount":"2392","inLanguage":"en","datePublished":"2016-03-23T13:34:03Z","dateModified":"2016-03-23T13:34:03Z","author":{"@type":"Person","name":"Jacob Martin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kubamartin.com/2016/03/23/web-app-using-microservices-in-go-part-4-worker-and-frontend/"},"publisher":{"@type":"Organization","name":"Jacob Martin","logo":{"@type":"ImageObject","url":"https://kubamartin.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kubamartin.com/ accesskey=h title="Jacob Martin (Alt + H)">Jacob Martin</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://kubamartin.com/ title="About Me"><span>About Me</span></a></li><li><a href=https://kubamartin.com/archive title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kubamartin.com/>Home</a>&nbsp;»&nbsp;<a href=https://kubamartin.com/posts/>Posts</a></div><h1 class=post-title>Web app using Microservices in Go: Part 4 – Worker and Frontend</h1><div class=post-meta>&lt;span title='2016-03-23 13:34:03 +0000 UTC'>March 23, 2016&lt;/span>&amp;nbsp;·&amp;nbsp;12 min&amp;nbsp;·&amp;nbsp;Jacob Martin&nbsp;|&nbsp;<a href=https://github.com/cube2222/cube2222.github.io/content/posts/2016-03-23-web-app-using-microservices-in-go-part-4-worker-and-frontend.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><a href=https://kubamartin.com/2016/03/21/web-app-using-microservices-in-go-part-3-storage-and-master/>Previous part</a></p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>In this part we will finally finish writing our application. We will implement the last two services:</p><ol><li>The Worker</li><li>The Frontend</li></ol><h2 id=the-worker>The Worker<a hidden class=anchor aria-hidden=true href=#the-worker>#</a></h2><p>The worker will communicate with the <em>Master</em> to get new <em>Tasks</em>. When it gets a <em>Task</em> it will get the corresponding data from the storage and will start working on the task. When it finishes it will send the finished data to the storage service, and if that succeeds it will register the <em>Task</em> as finished to the <em>Master</em>.</p><p>That means that you can easily scale the workforce, by turning on additional machines, with the worker service on them. Easy scaling is good!</p><h3 id=implementation>Implementation<a hidden class=anchor aria-hidden=true href=#implementation>#</a></h3><p>As usual we will start with a basic structure which is similar to the structure of our previous services. Although there is one big difference. There won’t be any API here as the worker will be a client. You could, if you wanted, add an API for debugging purposes. Things like getting the processor usage. But this can also be implemented using 3rd party health checking services.</p><p>So here’s our basic structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;image&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;image/png&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;image/color&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Task</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Id</span> <span style=color:#66d9ef>int</span> <span style=color:#e6db74>`json:&#34;id&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>State</span> <span style=color:#66d9ef>int</span> <span style=color:#e6db74>`json:&#34;state&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>masterLocation</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>storageLocation</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>keyValueStoreAddress</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: Too few arguments.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keyValueStoreAddress</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>keyValueStoreAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/get?key=masterAddress&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get master address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>masterLocation</span> = string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>masterLocation</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get master address. Length is zero.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>keyValueStoreAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/get?key=storageAddress&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get storage address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>storageLocation</span> = string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>storageLocation</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get storage address. Length is zero.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getNewTask</span>(<span style=color:#a6e22e>masterAddress</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>Task</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getImageFromStorage</span>(<span style=color:#a6e22e>storageAddress</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>myTask</span> <span style=color:#a6e22e>Task</span>) (<span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>doWorkOnImage</span>(<span style=color:#a6e22e>myImage</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>) <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendImageToStorage</span>(<span style=color:#a6e22e>storageAddress</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>myTask</span> <span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>myImage</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>registerFinishedTask</span>(<span style=color:#a6e22e>masterAddress</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>myTask</span> <span style=color:#a6e22e>Task</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It may seem to be much but there is nothing new actually in the most dense parts. We define the <em>Task</em> structure first and declare the needed addresses/locations.</p><p>Later we check if there are enough arguments passed to the application, and, as we did in the previous parts, we get the addresses of the <em>Master</em> and the <em>Storage</em>. That’s basically all.</p><p>For the worker we will want a command line parameter to set the number of concurrent threads. That’s why we check if there are 3 Arguments.</p><p>Now let’s parse the thread count:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>storageLocation</span> = string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>storageLocation</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get storage address. Length is zero.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>threadCount</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: Couldn&#39;t parse thread count.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We use the <em>atoi</em> function to parse the string argument to an int.</p><p>And now we come to the main for loop which runs on each thread:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>myWG</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span><span style=color:#a6e22e>myWG</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>threadCount</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>threadCount</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//Do work...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>myWG</span>.<span style=color:#a6e22e>Wait</span>()
</span></span></code></pre></div><p>Ok, what are we doing there? We create a <strong><em>waitGroup</em></strong>. The main function has to be waiting for the <strong>goroutines</strong> and not just finish execution, that’s why we create a waitGroup and add the thread count. You could add a functionality to break the endless for loop and after that use the <em>Done()</em> function on the waitgroup. We won’t be adding this as we just want endless for work loops.</p><p>Now we will write down the execution process for each <em>Task</em>.<br>First we get a new <em>Task</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myTask</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getNewTask</span>(<span style=color:#a6e22e>masterLocation</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>If we error, then we wait 2 seconds, so it doesn’t make a lot of errored requests to the master at once. As this could flood the other services.</p><p>If we successfully get the <em>Task</em>, then we get the image to work on from the storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>myTask</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getNewTask</span>(<span style=color:#a6e22e>masterLocation</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>myImage</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getImageFromStorage</span>(<span style=color:#a6e22e>storageLocation</span>, <span style=color:#a6e22e>myTask</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, now it’s time to do something with the image!!!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>myImage</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getImageFromStorage</span>(<span style=color:#a6e22e>storageLocation</span>, <span style=color:#a6e22e>myTask</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>myImage</span> = <span style=color:#a6e22e>doWorkOnImage</span>(<span style=color:#a6e22e>myImage</span>)
</span></span></code></pre></div><p>We now of course have to save the image back to the storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>myImage</span> = <span style=color:#a6e22e>doWorkOnImage</span>(<span style=color:#a6e22e>myImage</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sendImageToStorage</span>(<span style=color:#a6e22e>storageLocation</span>, <span style=color:#a6e22e>myTask</span>, <span style=color:#a6e22e>myImage</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And finally if that succeeds we register our successfully finished <em>Task</em>!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sendImageToStorage</span>(<span style=color:#a6e22e>storageLocation</span>, <span style=color:#a6e22e>myTask</span>, <span style=color:#a6e22e>myImage</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>registerFinishedTask</span>(<span style=color:#a6e22e>masterLocation</span>, <span style=color:#a6e22e>myTask</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Waiting 2 second timeout...&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}()
</span></span></code></pre></div><p>Ok, so now we can continue with implementing these functions. Let’s first implement the <em>getNewTask</em> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getNewTask</span>(<span style=color:#a6e22e>masterAddress</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>Task</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>masterAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/getNewTask&#34;</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Task</span>{<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>}, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Task</span>{<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>}, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myTask</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Task</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myTask</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Task</span>{<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>}, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>myTask</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We make the request to the master and check if it was successful. We read the response <em>body</em> to memory and finally <em>Unmarshal</em> the response <em>body</em> to our <em>Task</em> structure. Finally we return it.</p><p>Now we can implement the function to get the image from storage!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getImageFromStorage</span>(<span style=color:#a6e22e>storageAddress</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>myTask</span> <span style=color:#a6e22e>Task</span>) (<span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>storageAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/getImage?state=working&amp;id=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>myTask</span>.<span style=color:#a6e22e>Id</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myImage</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>png</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>myImage</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We get the response whose body is the raw image, so we just <em>Decode</em> it and return it if we succeed.</p><p>Now that we have our image we can finally do some work on it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>doWorkOnImage</span>(<span style=color:#a6e22e>myImage</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>) <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myCanvas</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>NewRGBA</span>(<span style=color:#a6e22e>myImage</span>.<span style=color:#a6e22e>Bounds</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>myCanvas</span>.<span style=color:#a6e22e>Rect</span>.<span style=color:#a6e22e>Max</span>.<span style=color:#a6e22e>X</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>j</span> &lt; <span style=color:#a6e22e>myCanvas</span>.<span style=color:#a6e22e>Rect</span>.<span style=color:#a6e22e>Max</span>.<span style=color:#a6e22e>Y</span>; <span style=color:#a6e22e>j</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>myImage</span>.<span style=color:#a6e22e>At</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span>).<span style=color:#a6e22e>RGBA</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>myColor</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>color</span>.<span style=color:#a6e22e>RGBA</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>myColor</span>.<span style=color:#a6e22e>R</span> = uint8(<span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>myColor</span>.<span style=color:#a6e22e>G</span> = uint8(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>myColor</span>.<span style=color:#a6e22e>B</span> = uint8(<span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>myColor</span>.<span style=color:#a6e22e>A</span> = uint8(<span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>myCanvas</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span>, <span style=color:#a6e22e>myColor</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>myCanvas</span>.<span style=color:#a6e22e>SubImage</span>(<span style=color:#a6e22e>myImage</span>.<span style=color:#a6e22e>Bounds</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The work is largely irrelevant, but I’ll explain it anyways. First we create a RGBA. That’s something like a canvas for drawing, and we create it with the size of our image. Later we draw on the canvas swapping the red with the green channel. Later we use the RGBA to return a new modified image, created from our canvas with the size of our original image.</p><p>After working on the image we have to send it back to the <em>storage system</em>. So let’s implement the <strong><em>sendImageToStorage</em></strong> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendImageToStorage</span>(<span style=color:#a6e22e>storageAddress</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>myTask</span> <span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>myImage</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>byte</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>png</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>buffer</span>, <span style=color:#a6e22e>myImage</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>storageAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/sendImage?state=finished&amp;id=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>myTask</span>.<span style=color:#a6e22e>Id</span>), <span style=color:#e6db74>&#34;image/png&#34;</span>, <span style=color:#a6e22e>buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We create a <strong>data</strong> <em>byte slice</em>, and from that a data <em>buffer</em> which allows us to use it as a <em>readwriter</em> interface. We then use this interface to encode our image to png into, and finally send it using a <strong>POST</strong> to the server. If everything works out, then we just return.</p><p>When we successfully saved the image, we can register to the <em>Master</em> that we finished the <em>Task</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>registerFinishedTask</span>(<span style=color:#a6e22e>masterAddress</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>myTask</span> <span style=color:#a6e22e>Task</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>masterAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/registerTaskFinished?id=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>myTask</span>.<span style=color:#a6e22e>Id</span>), <span style=color:#e6db74>&#34;test/plain&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Nothing fancy. Just sending a <strong>POST</strong> request to notify about finishing the task.</p><p>Ok, that’s all regarding the <em>worker</em>. You can turn it on and it will wait for <em>Tasks</em> to get. Which means we need to get the <em>Tasks</em> from the user to our service finally. And that leads us to…</p><h2 id=the-frontend>The Frontend<a hidden class=anchor aria-hidden=true href=#the-frontend>#</a></h2><p>This one will show the user the website and also parse the user form so the backend services only get the raw image data. It will be the only interface to our application for the user.</p><p>As usual, we’ll begin with the basic structure of the file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/url&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>indexPage</span> = <span style=color:#e6db74>&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Upload file&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form enctype=\&#34;multipart/form-data\&#34; action=\&#34;submitTask\&#34; method=\&#34;post\&#34;&gt; &lt;input type=\&#34;file\&#34; name=\&#34;uploadfile\&#34; /&gt; &lt;input type=\&#34;submit\&#34; value=\&#34;upload\&#34; /&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>keyValueStoreAddress</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>masterLocation</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: Too few arguments.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keyValueStoreAddress</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>keyValueStoreAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/get?key=masterAddress&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get master address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>masterLocation</span> = string(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>masterLocation</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Error: can&#39;t get master address. Length is zero.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>handleIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/submitTask&#34;</span>, <span style=color:#a6e22e>handleTask</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/isReady&#34;</span>, <span style=color:#a6e22e>handleCheckForReadiness</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/getImage&#34;</span>, <span style=color:#a6e22e>serveImage</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:80&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleIndex</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleTask</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleCheckForReadiness</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>serveImage</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We’ve got the code of our index web page here, and we also have the <strong><em>API</em></strong> declared. After starting the program we check if we have the k/v store address. If we do (we hope so), then we can get the <em>master address</em> from it.</p><p>Now we can go on to implementing the functions. We’ll start with the simples. The index handler:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleIndex</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>indexPage</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After writing this we can go on to writing the more complicated functions. We will start with the <em>handleTask</em> function. This function is responsible for parsing the user form and sending the raw image data to the master.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleTask</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ParseMultipartForm</span>(<span style=color:#ae81ff>10000000</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Wrong input&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>FormFile</span>(<span style=color:#e6db74>&#34;uploadfile&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Wrong input&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Ok, what do we have here? We check the method as we always do, and later parse the multipart form. We’ve got a nice lovely magic number there. The number is responsible for setting the max size of the form held in RAM. The rest will be stored in temporary files. We later do the request using the file we got:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Wrong input&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>masterLocation</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/new&#34;</span>, <span style=color:#e6db74>&#34;image&#34;</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, string(<span style=color:#a6e22e>data</span>))
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error: Only POST accepted&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We send the user back the new <em>Task id</em> we got back from the <em>master</em>.</p><p>Now we can implement the function which will handle the request to check if the <em>Task</em> is finished and ready:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleCheckForReadiness</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>ParseQuery</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>RawQuery</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;id&#34;</span>)) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Wrong input&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>masterLocation</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/isReady?id=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;id&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;state=finished&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> string(<span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;0&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Your image is not ready yet.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;1&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Your image is ready.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span> :
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Internal server error.&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error: Only GET accepted&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Most of this is the same as the function in the <em>master</em>. We just check if the id is correct and make a request to the <em>master</em>. The interesting part is this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>switch</span> string(<span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;0&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Your image is not ready yet.&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;1&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Your image is ready.&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>default</span> :
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Internal server error.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We cast the <em>response body</em> to a string, and if it matches 1 or 0 we answer. If it’s something else then we know something went really wrong, and send back an error.</p><p>Now we can get to the last function, the function to serve the actual images:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>serveImage</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>values</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>ParseQuery</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>RawQuery</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;id&#34;</span>)) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Wrong input&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>masterLocation</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/get?id=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;id&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;state=finished&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Error: Only GET accepted&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It just checks the <em>id</em>, sends the <em>request</em>, and copies the <em>response</em> to answer the user.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>So now it’s all finished. You can start all applications and they will work. You can contact the frontend and make requests, they will all start working and you will get your modified images. Six microservices working beautifully together.</p><p>This may be the end of this series, so have fun extending this system alone.</p><p>I may add a finishing part about deployment to container infrastructues, or a another extending series about refactoring the system with 3rd party libraries in the future but I’m not sure.</p><p>All in all, good luck!</p><p>UPDATE: Also remember, that when running the worker, it’s good to launch it with goroutines in the number of 2-4x your system threads. They have near-0 overhead in switching and this way your not unnecessarily blocking when waiting for http responses.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kubamartin.com/tags/architecture/>Architecture</a></li><li><a href=https://kubamartin.com/tags/design/>Design</a></li><li><a href=https://kubamartin.com/tags/frontend/>Frontend</a></li><li><a href=https://kubamartin.com/tags/go/>Go</a></li><li><a href=https://kubamartin.com/tags/golang/>Golang</a></li><li><a href=https://kubamartin.com/tags/microservice/>Microservice</a></li><li><a href=https://kubamartin.com/tags/tutorial/>Tutorial</a></li><li><a href=https://kubamartin.com/tags/worker/>Worker</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Web app using Microservices in Go: Part 4 – Worker and Frontend on twitter" href="https://twitter.com/intent/tweet/?text=Web%20app%20using%20Microservices%20in%20Go%3a%20Part%204%20%e2%80%93%20Worker%20and%20Frontend&amp;url=https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f&amp;hashtags=architecture%2cdesign%2cfrontend%2cgo%2cgolang%2cmicroservice%2ctutorial%2cworker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Web app using Microservices in Go: Part 4 – Worker and Frontend on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f&amp;title=Web%20app%20using%20Microservices%20in%20Go%3a%20Part%204%20%e2%80%93%20Worker%20and%20Frontend&amp;summary=Web%20app%20using%20Microservices%20in%20Go%3a%20Part%204%20%e2%80%93%20Worker%20and%20Frontend&amp;source=https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Web app using Microservices in Go: Part 4 – Worker and Frontend on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f&title=Web%20app%20using%20Microservices%20in%20Go%3a%20Part%204%20%e2%80%93%20Worker%20and%20Frontend"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Web app using Microservices in Go: Part 4 – Worker and Frontend on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Web app using Microservices in Go: Part 4 – Worker and Frontend on whatsapp" href="https://api.whatsapp.com/send?text=Web%20app%20using%20Microservices%20in%20Go%3a%20Part%204%20%e2%80%93%20Worker%20and%20Frontend%20-%20https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Web app using Microservices in Go: Part 4 – Worker and Frontend on telegram" href="https://telegram.me/share/url?text=Web%20app%20using%20Microservices%20in%20Go%3a%20Part%204%20%e2%80%93%20Worker%20and%20Frontend&amp;url=https%3a%2f%2fkubamartin.com%2f2016%2f03%2f23%2fweb-app-using-microservices-in-go-part-4-worker-and-frontend%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://kubamartin.com/>Jacob Martin</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
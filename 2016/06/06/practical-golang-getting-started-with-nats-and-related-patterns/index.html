<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Practical Golang: Getting started with NATS and related patterns | Jacob Martin</title>
<meta name=keywords content="event,go,golang,master,message,microservice,NATS,pattern,protobuf,pub,slave,sub,subscribe,worker"><meta name=description content="Practical Golang: Getting started with NATS and related patterns Introduction Microservices… the never disappearing buzzword of our times. They promise a lot, but can be slow or complicated if not implemented correctly. One of the main challenges when developing and using a microservice-based architecture is getting the communication right. Many will ask, why not REST? As I did at some point. Many will actually use it. But the truth is that it leads to tighter coupling, and is synchronous."><meta name=author content="Jacob Martin"><link rel=canonical href=https://kubamartin.com/2016/06/06/practical-golang-getting-started-with-nats-and-related-patterns/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://kubamartin.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kubamartin.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kubamartin.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kubamartin.com/apple-touch-icon.png><link rel=mask-icon href=https://kubamartin.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kubamartin.com/2016/06/06/practical-golang-getting-started-with-nats-and-related-patterns/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Practical Golang: Getting started with NATS and related patterns"><meta property="og:description" content="Practical Golang: Getting started with NATS and related patterns Introduction Microservices… the never disappearing buzzword of our times. They promise a lot, but can be slow or complicated if not implemented correctly. One of the main challenges when developing and using a microservice-based architecture is getting the communication right. Many will ask, why not REST? As I did at some point. Many will actually use it. But the truth is that it leads to tighter coupling, and is synchronous."><meta property="og:type" content="article"><meta property="og:url" content="https://kubamartin.com/2016/06/06/practical-golang-getting-started-with-nats-and-related-patterns/"><meta property="og:image" content="https://kubamartin.com/images/avatar.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-06-06T11:51:48+00:00"><meta property="article:modified_time" content="2016-06-06T11:51:48+00:00"><meta property="og:site_name" content="Jacob Martin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kubamartin.com/images/avatar.jpg"><meta name=twitter:title content="Practical Golang: Getting started with NATS and related patterns"><meta name=twitter:description content="Practical Golang: Getting started with NATS and related patterns Introduction Microservices… the never disappearing buzzword of our times. They promise a lot, but can be slow or complicated if not implemented correctly. One of the main challenges when developing and using a microservice-based architecture is getting the communication right. Many will ask, why not REST? As I did at some point. Many will actually use it. But the truth is that it leads to tighter coupling, and is synchronous."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kubamartin.com/posts/"},{"@type":"ListItem","position":2,"name":"Practical Golang: Getting started with NATS and related patterns","item":"https://kubamartin.com/2016/06/06/practical-golang-getting-started-with-nats-and-related-patterns/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Practical Golang: Getting started with NATS and related patterns","name":"Practical Golang: Getting started with NATS and related patterns","description":"Practical Golang: Getting started with NATS and related patterns Introduction Microservices… the never disappearing buzzword of our times. They promise a lot, but can be slow or complicated if not implemented correctly. One of the main challenges when developing and using a microservice-based architecture is getting the communication right. Many will ask, why not REST? As I did at some point. Many will actually use it. But the truth is that it leads to tighter coupling, and is synchronous.","keywords":["event","go","golang","master","message","microservice","NATS","pattern","protobuf","pub","slave","sub","subscribe","worker"],"articleBody":"Practical Golang: Getting started with NATS and related patterns Introduction Microservices… the never disappearing buzzword of our times. They promise a lot, but can be slow or complicated if not implemented correctly. One of the main challenges when developing and using a microservice-based architecture is getting the communication right. Many will ask, why not REST? As I did at some point. Many will actually use it. But the truth is that it leads to tighter coupling, and is synchronous. Microservice architectures are meant to be asynchronous. Also, REST is blocking, which also isn’t good on many occasions.\nWhat are we meant to use for communication? Usually we use:\n– RPC – Remote Procedure Call\n– Message BUS/Broker\nIn this article I’ll write about one specific Message BUS called NATS and using it in Go.\nThere are also other message BUS’ses/Brokers. Some popular ones are Kafka and RabbitMQ.\nWhy NATS? It’s simple, and astonishingly fast.\nSetting up NATS To use NATS you can do one of the following things:\nUse the NATS Docker image Get the binaries Use the public NATS server nats://demo.nats.io:4222 Build from source Also, remember to\ngo get https://github.com/nats-io/nats the official Go library.\nGetting started In this article we’ll be using protobuffs a lot. So if you want to know more about them, check out my previous article about protobuffs.\nFirst, let’s write one of the key usages of microservices. A fronted, that lists information from other micrservices, but doesn’t care if one of them is down. It will respond to the user anyways. This makes microservices swappable live, one at a time.\nIn each of our services we’ll need to connect to NATS:\npackage main import ( \"github.com/nats-io/nats\" \"fmt\" ) var nc *nats.Conn func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } var err error nc, err = nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } } Now, let’s write the first provider service. It will receive a User Id, and answer with a user name For which we’ll need a transport structure to send its data over NATS. I wrote this short proto file for that:\nsyntax = \"proto3\"; package Transport; message User { string id = 1; string name = 2; } Now we will create the map containing our user names:\nvar users map[string]string var nc *nats.Conn func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } var err error nc, err = nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } users = make(map[string]string) users[\"1\"] = \"Bob\" users[\"2\"] = \"John\" users[\"3\"] = \"Dan\" users[\"4\"] = \"Kate\" } and finally the part that’s most interesting to us. Subscribing to the topic:\nusers[\"4\"] = \"Kate\" nc.QueueSubscribe(\"UserNameById\", \"userNameByIdProviders\", replyWithUserId) Notice that it’s a QueueSubscribe. Which means that if we start 10 instances of this service in the userNameByIdProviders group , only one will get each message sent over UserNameById. Another thing to note is that this function call is asynchronous, so we need to block somehow. This select {} will provide an endless block:\nnc.QueueSubscribe(\"UserNameById\", \"userNameByIdProviders\", replyWithUserId) select {} } Ok, now to the replyWithUserId function:\nfunc replyWithUserId(m *nats.Msg) { } Notice that it takes one argument, a pointer to the message.\nWe’ll unmarshal the data:\nfunc replyWithUserId(m *nats.Msg) { myUser := Transport.User{} err := proto.Unmarshal(m.Data, \u0026myUser) if err != nil { fmt.Println(err) return } get the name and marshal back:\nmyUser.Name = users[myUser.Id] data, err := proto.Marshal(\u0026myUser) if err != nil { fmt.Println(err) return } And, as this shall be a request we’re handling, we respond to the Reply topic, a topic created by the caller exactly for this purpose:\nif err != nil { fmt.Println(err) return } fmt.Println(\"Replying to \", m.Reply) nc.Publish(m.Reply, data) } Ok, now let’s get to the second service. Our time provider service, first the same basic structure:\npackage main import ( \"github.com/nats-io/nats\" \"fmt\" \"github.com/cube2222/Blog/NATS/FrontendBackend\" \"github.com/golang/protobuf/proto\" \"os\" \"sync\" \"time\" ) // We use globals because it's a small application demonstrating NATS. var nc *nats.Conn func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } var err error nc, err = nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } nc.QueueSubscribe(\"TimeTeller\", \"TimeTellers\", replyWithTime) select {} // Block forever } This time we’re not getting any data from the caller, so we just marshal our time into this proto structure:\nsyntax = \"proto3\"; package Transport; message Time { string time = 1; } and send it back:\nfunc replyWithTime(m *nats.Msg) { curTime := Transport.Time{time.Now().Format(time.RFC3339)} data, err := proto.Marshal(\u0026curTime) if err != nil { fmt.Println(err) return } fmt.Println(\"Replying to \", m.Reply) nc.Publish(m.Reply, data) } We can now get to our frontend, which will use both those services. First the standard basic structure:\npackage main import ( \"net/http\" \"github.com/gorilla/mux\" \"github.com/cube2222/Blog/NATS/FrontendBackend\" \"github.com/golang/protobuf/proto\" \"fmt\" \"github.com/nats-io/nats\" \"time\" \"os\" \"sync\" ) var nc *nats.Conn func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } var err error nc, err = nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } m := mux.NewRouter() m.HandleFunc(\"/{id}\", handleUserWithTime) http.ListenAndServe(\":3000\", m) } That’s a pretty standard web server, now to the interesting bits, the handleUserWithTime function, which will respond with the user name and time:\nfunc handleUserWithTime(w http.ResponseWriter, r *http.Request) { vars := mux.Vars(r) myUser := Transport.User{Id: vars[\"id\"]} curTime := Transport.Time{} wg := sync.WaitGroup{} wg.Add(2) } We’ve parsed the request arguments and started a WaitGroup with the value two, as we will do one asynchronous request for each of our services. First we’ll marshal the user struct:\ngo func() { data, err := proto.Marshal(\u0026myUser) if err != nil || len(myUser.Id) == 0 { fmt.Println(err) w.WriteHeader(500) fmt.Println(\"Problem with parsing the user Id.\") return } and, then we make a request. Sending the user data, and waiting at most 100 ms for the response:\nfmt.Println(\"Problem with parsing the user Id.\") return } msg, err := nc.Request(\"UserNameById\", data, 100 * time.Millisecond) now we can check if any error happend, or the response is empty and finish this thread:\nmsg, err := nc.Request(\"UserNameById\", data, 100 * time.Millisecond) if err == nil \u0026\u0026 msg != nil { myUserWithName := Transport.User{} err := proto.Unmarshal(msg.Data, \u0026myUserWithName) if err == nil { myUser = myUserWithName } } wg.Done() }() Next we’ll do the request to the Time Tellers.\nWe again make a request, but its body is nil, as we don’t need to pass any data:\ngo func() { msg, err := nc.Request(\"TimeTeller\", nil, 100*time.Millisecond) if err == nil \u0026\u0026 msg != nil { receivedTime := Transport.Time{} err := proto.Unmarshal(msg.Data, \u0026receivedTime) if err == nil { curTime = receivedTime } } wg.Done() }() After both requests finished (or failed) we can just respond to the user:\nwg.Wait() fmt.Fprintln(w, \"Hello \", myUser.Name, \" with id \", myUser.Id, \", the time is \", curTime.Time, \".\") } Now if you actually test it, you’ll notice that if one of the provider services isn’t active, the frontend will respond anyways, putting a zero’ed value in place of the non-available resource. You could also make a template that shows an error in that place.\nOk, that was already an interesting architecture. Now we can implement…\nThe Master-Slave pattern This is such a popular pattern, especially in Go, that we really should know how to implement it. The workers will do simple operations on a text file (count the usage amounts of each word in a comma-separated list).\nNow you could think that the Master, should send the files to the Workers over NATS. Wrong. This would lead to a huge slowdown of NATS (at least for bigger files). That’s why the Master will send the files to a file server over a REST API, and the Workers will get it from there. We’ll also learn how to do service discovery over NATS.\nFirst, the File Server. I won’t really go through the file handling part, as it’s a simple get/post API.I will however, go over the service discovery part.\npackage main import ( \"net/http\" \"github.com/gorilla/mux\" \"os\" \"io\" \"fmt\" \"github.com/nats-io/nats\" \"github.com/cube2222/Blog/NATS/MasterWorker\" \"github.com/golang/protobuf/proto\" ) func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } m := mux.NewRouter() m.HandleFunc(\"/{name}\", func(w http.ResponseWriter, r *http.Request) { vars := mux.Vars(r) file, err := os.Open(\"/tmp/\" + vars[\"name\"]) defer file.Close() if err != nil { w.WriteHeader(404) } if file != nil { _, err := io.Copy(w, file) if err != nil { w.WriteHeader(500) } } }).Methods(\"GET\") m.HandleFunc(\"/{name}\", func(w http.ResponseWriter, r *http.Request) { vars := mux.Vars(r) file, err := os.Create(\"/tmp/\" + vars[\"name\"]) defer file.Close() if err != nil { w.WriteHeader(500) } if file != nil { _, err := io.Copy(file, r.Body) if err != nil { w.WriteHeader(500) } } }).Methods(\"POST\") RunServiceDiscoverable() http.ListenAndServe(\":3000\", m) } Now, what does the RunServiceDiscoverable function do? It connects to the NATS server and responds with its own http address to incoming requests.\nfunc RunServiceDiscoverable() { nc, err := nats.Connect(os.Args[1]) if err != nil { fmt.Println(\"Can't connect to NATS. Service is not discoverable.\") } nc.Subscribe(\"Discovery.FileServer\", func(m *nats.Msg) { serviceAddressTransport := Transport.DiscoverableServiceTransport{\"http://localhost:3000\"} data, err := proto.Marshal(\u0026serviceAddressTransport) if err == nil { nc.Publish(m.Reply, data) } }) } The proto file looks like this:\nsyntax = \"proto3\"; package Transport; message DiscoverableServiceTransport { string Address = 1; } We can now go on with the Master.\nThe protofile for the Task structure is:\nsyntax = \"proto3\"; package Transport; message Task { string uuid = 1; string finisheduuid = 2; int32 state = 3; // 0 - not started, 1 - in progress, 2 - finished int32 id = 4; } Our Master will hold a list of tasks with the respecting UUID (at the same time the name of the file), id (the position in the master Tasks slice), and a pointer which holds the position of the last not finished Task, which will get updated on new Task retrieval. It’s pretty similar to the Task storage in my Microservice Architecture series\nI’m using github.com/satori/go.uuid for UUID generation.\nFirst, as usual, the basic structure:\npackage main import ( \"github.com/satori/go.uuid\" \"github.com/cube2222/Blog/NATS/MasterWorker\" \"os\" \"fmt\" \"github.com/nats-io/nats\" \"github.com/golang/protobuf/proto\" \"time\" \"bytes\" \"net/http\" \"sync\" ) var Tasks []Transport.Task var TaskMutex sync.Mutex var oldestFinishedTaskPointer int var nc *nats.Conn func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } var err error nc, err = nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } Tasks = make([]Transport.Task, 0, 20) TaskMutex = sync.Mutex{} oldestFinishedTaskPointer = 0 initTestTasks() wg := sync.WaitGroup{} nc.Subscribe(\"Work.TaskToDo\", func (m *nats.Msg) { }) nc.Subscribe(\"Work.TaskFinished\", func (m *nats.Msg) { }) select {} // Block forever } Ok, we’ve also already set up the Subscriptions\nHow does the initTestTasks function work? It’s interesting because it gets the file server address over NATS.\nSo, we want to create 20 test Tasks, so we run the loop 20 times:\nfunc initTestTasks() { for i := 0; i \u003c 20; i++ { } } We create a new Task and ask the File Server for its address:\nfor i := 0; i \u003c 20; i++ { newTask := Transport.Task{Uuid: uuid.NewV4().String(), State: 0} fileServerAddressTransport := Transport.DiscoverableServiceTransport{} msg, err := nc.Request(\"Discovery.FileServer\", nil, 1000 * time.Millisecond) if err == nil \u0026\u0026 msg != nil { err := proto.Unmarshal(msg.Data, \u0026fileServerAddressTransport) if err != nil { continue } } if err != nil { continue } fileServerAddress := fileServerAddressTransport.Address } Next we finally make the post Request to the file server and add the Task to our Tasks list:\nfileServerAddress := fileServerAddressTransport.Address data := make([]byte, 0, 1024) buf := bytes.NewBuffer(data) fmt.Fprint(buf, \"get,my,data,my,get,get,have\") r, err := http.Post(fileServerAddress + \"/\" + newTask.Uuid, \"\", buf) if err != nil || r.StatusCode != http.StatusOK { continue } newTask.Id = int32(len(Tasks)) Tasks = append(Tasks, newTask) } How do we dispatch new Tasks to do? Simply like this:\nnc.Subscribe(\"Work.TaskToDo\", func (m *nats.Msg) { myTaskPointer, ok := getNextTask() if ok { data, err := proto.Marshal(myTaskPointer) if err == nil { nc.Publish(m.Reply, data) } } }) How do we get the next Task? We just loop over the Task to find one that is not started. If tasks above our pointer are all finished, then we also move up the pointer. Remember the mutex as this function may be run in parallel:\nfunc getNextTask() (*Transport.Task, bool) { TaskMutex.Lock() defer TaskMutex.Unlock() for i := oldestFinishedTaskPointer; i \u003c len(Tasks); i++ { if i == oldestFinishedTaskPointer \u0026\u0026 Tasks[i].State == 2 { oldestFinishedTaskPointer++ } else { if Tasks[i].State == 0 { Tasks[i].State = 1 go resetTaskIfNotFinished(i) return \u0026Tasks[i], true } } } return nil, false } We also called the resetTaskIfNotFinished function. It will reset the Task state if it’s still in progress after 2 minutes:\nfunc resetTaskIfNotFinished(i int) { time.Sleep(2 * time.Minute) TaskMutex.Lock() if Tasks[i].State != 2 { Tasks[i].State = 0 } } The TaskFinished subscription handler is much simpler, it just sets the Task to finished, and the UUID accordingly to the received protobuffer:\nnc.Subscribe(\"Work.TaskFinished\", func (m *nats.Msg) { myTask := Transport.Task{} err := proto.Unmarshal(m.Data, \u0026myTask) if err == nil { TaskMutex.Lock() Tasks[myTask.Id].State = 2 Tasks[myTask.Id].Finisheduuid = myTask.Finisheduuid TaskMutex.Unlock() } }) That’s all in regards to the Master! We can now move on writing the Worker.\nThe basic structure:\npackage main import ( \"os\" \"fmt\" \"github.com/nats-io/nats\" \"time\" \"github.com/cube2222/Blog/NATS/MasterWorker\" \"github.com/golang/protobuf/proto\" \"net/http\" \"bytes\" \"io/ioutil\" \"sort\" \"strings\" \"github.com/satori/go.uuid\" \"sync\" ) var nc *nats.Conn func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } var err error nc, err = nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } for i := 0; i \u003c 8; i++ { go doWork() } select {} // Block forever } Now the main function doing something here is the doWork function. I’ll post it all at once with comments everywhere, as it’s a very long function and this will be the most convenient way to read it:\nfunc doWork() { for { // We ask for a Task with a 1 second Timeout msg, err := nc.Request(\"Work.TaskToDo\", nil, 1 * time.Second) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } // We unmarshal the Task curTask := Transport.Task{} err = proto.Unmarshal(msg.Data, \u0026curTask) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } // We get the FileServer address msg, err = nc.Request(\"Discovery.FileServer\", nil, 1000 * time.Millisecond) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } fileServerAddressTransport := Transport.DiscoverableServiceTransport{} err = proto.Unmarshal(msg.Data, \u0026fileServerAddressTransport) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } // We get the file fileServerAddress := fileServerAddressTransport.Address r, err := http.Get(fileServerAddress + \"/\" + curTask.Uuid) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } data, err := ioutil.ReadAll(r.Body) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } // We split and count the words words := strings.Split(string(data), \",\") sort.Strings(words) wordCounts := make(map[string]int) for i := 0; i \u003c len(words); i++{ wordCounts[words[i]] = wordCounts[words[i]] + 1 } resultData := make([]byte, 0, 1024) buf := bytes.NewBuffer(resultData) // We print the results to a buffer for key, value := range wordCounts { fmt.Fprintln(buf, key, \":\", value) } // We generate a new UUID for the finished file curTask.Finisheduuid = uuid.NewV4().String() r, err = http.Post(fileServerAddress + \"/\" + curTask.Finisheduuid, \"\", buf) if err != nil || r.StatusCode != http.StatusOK { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err, \":\", r.StatusCode) continue } // We marshal the current Task into a protobuffer data, err = proto.Marshal(\u0026curTask) if err != nil { fmt.Println(\"Something went wrong. Waiting 2 seconds before retrying:\", err) continue } // We notify the Master about finishing the Task nc.Publish(\"Work.TaskFinished\", data) } } Awesome, our Master-Slave setup is ready, you can test it if you’d like. After you do, we can now check out the last architecture.\nThe Events pattern Imagine you have servers which keep connections to clients over websockets. You want these clients to get live news updates. With this pattern you can. We’ll also learn about a few convenient NATS client abstractions. Like using a encoded connection, or using channels for sending/receiving.\nThe basic architecture as usual:\npackage main import ( \"os\" \"fmt\" \"github.com/nats-io/nats\" natsp \"github.com/nats-io/nats/encoders/protobuf\" \"github.com/cube2222/Blog/NATS/EventSubs\" \"time\" ) func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } nc, err := nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } ec, err := nats.NewEncodedConn(nc, natsp.PROTOBUF_ENCODER) defer ec.Close() } Wait… What’s that at the end!? It’s an encoded connection! It will automatically encode our structs into raw data. We’ll use the protobuf one, but there are a default one, a gob one and a json one too.\nHere’s the protofile we’ll use:\nsyntax = \"proto3\"; package Transport; message TextMessage { int32 id = 1; string body = 2; } Ok, how can we just publish simple event-structs? Totally intuitive, like that:\ndefer ec.Close() for i := 0; i \u003c 5; i++ { myMessage := Transport.TextMessage{Id: int32(i), Body: \"Hello over standard!\"} err := ec.Publish(\"Messaging.Text.Standard\", \u0026myMessage) if err != nil { fmt.Println(err) } } It’s a little bit counter intuitive with Requests. As the signature differs, it follows like this:\nerr := ec.Request(topic, *body, *response, timeout) So our request sending part will look like this:\nfor i := 5; i \u003c 10; i++ { myMessage := Transport.TextMessage{Id: int32(i), Body: \"Hello, please respond!\"} res := Transport.TextMessage{} err := ec.Request(\"Messaging.Text.Respond\", \u0026myMessage, \u0026res, 200 * time.Millisecond) if err != nil { fmt.Println(err) } fmt.Println(res.Body, \" with id \", res.Id) } The last thing we can do is sending them via Channels, which is relatively the simplest:\nsendChannel := make(chan *Transport.TextMessage) ec.BindSendChan(\"Messaging.Text.Channel\", sendChannel) for i := 10; i \u003c 15; i++ { myMessage := Transport.TextMessage{Id: int32(i), Body: \"Hello over channel!\"} sendChannel \u003c- \u0026myMessage } Now we can write the receiving end. First the same structure as before:\npackage main import ( \"github.com/nats-io/nats\" natsp \"github.com/nats-io/nats/encoders/protobuf\" \"os\" \"fmt\" \"github.com/cube2222/Blog/NATS/EventSubs\" ) func main() { if len(os.Args) != 2 { fmt.Println(\"Wrong number of arguments. Need NATS server address.\") return } nc, err := nats.Connect(os.Args[1]) if err != nil { fmt.Println(err) } ec, err := nats.NewEncodedConn(nc, natsp.PROTOBUF_ENCODER) defer ec.Close() } Ok, first the standard receive which is totally natural:\ndefer ec.Close() ec.Subscribe(\"Messaging.Text.Standard\", func(m *Transport.TextMessage) { fmt.Println(\"Got standard message: \\\"\", m.Body, \"\\\" with the Id \", m.Id, \".\") }) Now, the responding, which has a little bit changed syntax again. As the handler function is:\nfunc (subject, reply string, m *Transport.TextMessage) So the responding looks like this:\nec.Subscribe(\"Messaging.Text.Respond\", func(subject, reply string, m *Transport.TextMessage) { fmt.Println(\"Got ask for response message: \\\"\", m.Body, \"\\\" with the Id \", m.Id, \".\") newMessage := Transport.TextMessage{Id: m.Id, Body: \"Responding!\"} ec.Publish(reply, \u0026newMessage) }) And finally using channels, which doesn’t differ nearly at all in comparison to the sending side:\nreceiveChannel := make(chan *Transport.TextMessage) ec.BindRecvChan(\"Messaging.Text.Channel\", receiveChannel) for m := range receiveChannel { fmt.Println(\"Got channel'ed message: \\\"\", m.Body, \"\\\" with the Id \", m.Id, \".\") } Ok, that’s all in the topic of NATS. I hope you liked it and discovered something new! Please comment if you have any opinions, or don’t like something, or just want me to write about something.\nNow go and build something great!\n","wordCount":"3172","inLanguage":"en","image":"https://kubamartin.com/images/avatar.jpg","datePublished":"2016-06-06T11:51:48Z","dateModified":"2016-06-06T11:51:48Z","author":{"@type":"Person","name":"Jacob Martin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kubamartin.com/2016/06/06/practical-golang-getting-started-with-nats-and-related-patterns/"},"publisher":{"@type":"Organization","name":"Jacob Martin","logo":{"@type":"ImageObject","url":"https://kubamartin.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kubamartin.com/ accesskey=h title="Jacob Martin (Alt + H)">Jacob Martin</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kubamartin.com/ title="About Me"><span>About Me</span></a></li><li><a href=https://kubamartin.com/archive title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kubamartin.com/>Home</a>&nbsp;»&nbsp;<a href=https://kubamartin.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Practical Golang: Getting started with NATS and related patterns</h1><div class=post-meta><span title='2016-06-06 11:51:48 +0000 UTC'>June 6, 2016</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;Jacob Martin&nbsp;|&nbsp;<a href=https://github.com/cube2222/cube2222.github.io/content/posts/2016-06-06-practical-golang-getting-started-with-nats-and-related-patterns.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h1 id=practical-golang-getting-started-with-nats-and-related-patterns>Practical Golang: Getting started with NATS and related patterns<a hidden class=anchor aria-hidden=true href=#practical-golang-getting-started-with-nats-and-related-patterns>#</a></h1><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Microservices… the never disappearing buzzword of our times. They promise a lot, but can be slow or complicated if not implemented correctly. One of the main challenges when developing and using a microservice-based architecture is getting the <em>communication</em> right. Many will ask, why not <strong>REST</strong>? As I did at some point. Many will actually use it. But the truth is that it leads to tighter coupling, and is <em>synchronous</em>. Microservice architectures are meant to be asynchronous. Also, REST is blocking, which also isn’t good on many occasions.</p><p>What are we meant to use for communication? Usually we use:<br>– RPC – Remote Procedure Call<br>– Message BUS/Broker</p><p>In this article I’ll write about one specific Message BUS called <strong>NATS</strong> and using it in Go.</p><p>There are also other message BUS’ses/Brokers. Some popular ones are <strong>Kafka</strong> and <strong>RabbitMQ</strong>.</p><p>Why NATS? It’s simple, and astonishingly fast.</p><h2 id=setting-up-nats>Setting up NATS<a hidden class=anchor aria-hidden=true href=#setting-up-nats>#</a></h2><p>To use NATS you can do one of the following things:</p><ol><li>Use the <a href=https://hub.docker.com/_/nats/>NATS Docker image</a></li><li>Get the <a href=https://github.com/nats-io/gnatsd/releases/>binaries</a></li><li>Use the public NATS server <em>nats://demo.nats.io:4222</em></li><li>Build from <a href=https://github.com/nats-io/gnatsd>source</a></li></ol><p>Also, remember to</p><pre><code>go get https://github.com/nats-io/nats
</code></pre><p>the official Go library.</p><h2 id=getting-started>Getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h2><p>In this article we’ll be using protobuffs a lot. So if you want to know more about them, check out my <a href=https://kubamartin.com/2016/05/24/practical-golang-using-protobuffs/>previous article about protobuffs</a>.</p><p>First, let’s write one of the key usages of microservices. A fronted, that lists information from other micrservices, but doesn’t care if one of them is down. It will respond to the user anyways. This makes microservices swappable live, one at a time.</p><p>In each of our services we’ll need to connect to NATS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, let’s write the first provider service. It will receive a <em>User Id</em>, and answer with a <em>user name</em> For which we’ll need a transport structure to send its data over <em>NATS</em>. I wrote this short proto file for that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> Transport;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>User</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> name <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Now we will create the map containing our user names:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>users</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>[<span style=color:#e6db74>&#34;1&#34;</span>] = <span style=color:#e6db74>&#34;Bob&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>[<span style=color:#e6db74>&#34;2&#34;</span>] = <span style=color:#e6db74>&#34;John&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>[<span style=color:#e6db74>&#34;3&#34;</span>] = <span style=color:#e6db74>&#34;Dan&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>[<span style=color:#e6db74>&#34;4&#34;</span>] = <span style=color:#e6db74>&#34;Kate&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and finally the part that’s most interesting to us. Subscribing to the topic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>users</span>[<span style=color:#e6db74>&#34;4&#34;</span>] = <span style=color:#e6db74>&#34;Kate&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>QueueSubscribe</span>(<span style=color:#e6db74>&#34;UserNameById&#34;</span>, <span style=color:#e6db74>&#34;userNameByIdProviders&#34;</span>, <span style=color:#a6e22e>replyWithUserId</span>)
</span></span></code></pre></div><p>Notice that it’s a <strong>QueueSubscribe</strong>. Which means that if we start 10 instances of this service in the <em>userNameByIdProviders</em> group , only one will get each message sent over <em>UserNameById</em>. Another thing to note is that this function call is asynchronous, so we need to block somehow. This <em>select {}</em> will provide an endless block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>QueueSubscribe</span>(<span style=color:#e6db74>&#34;UserNameById&#34;</span>, <span style=color:#e6db74>&#34;userNameByIdProviders&#34;</span>, <span style=color:#a6e22e>replyWithUserId</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>select</span> {}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, now to the <em>replyWithUserId</em> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>replyWithUserId</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Notice that it takes one argument, a pointer to the message.</p><p>We’ll unmarshal the data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>replyWithUserId</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>User</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myUser</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>get the name and marshal back:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>myUser</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>users</span>[<span style=color:#a6e22e>myUser</span>.<span style=color:#a6e22e>Id</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myUser</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And, as this shall be a request we’re handling, we respond to the <em>Reply topic</em>, a topic created by the caller exactly for this purpose:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Replying to &#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Reply</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Reply</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, now let’s get to the second service. Our time provider service, first the same basic structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/FrontendBackend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// We use globals because it&#39;s a small application demonstrating NATS.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>QueueSubscribe</span>(<span style=color:#e6db74>&#34;TimeTeller&#34;</span>, <span style=color:#e6db74>&#34;TimeTellers&#34;</span>, <span style=color:#a6e22e>replyWithTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {} <span style=color:#75715e>// Block forever
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>This time we’re not getting any data from the caller, so we just marshal our time into this proto structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> Transport;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Time</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> time <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>and send it back:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>replyWithTime</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>curTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Time</span>{<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Format</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>RFC3339</span>)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>curTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Replying to &#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Reply</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Reply</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can now get to our frontend, which will use both those services. First the standard basic structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/FrontendBackend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>NewRouter</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/{id}&#34;</span>, <span style=color:#a6e22e>handleUserWithTime</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:3000&#34;</span>, <span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That’s a pretty standard web server, now to the interesting bits, the <em>handleUserWithTime</em> function, which will respond with the user name and time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleUserWithTime</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vars</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Vars</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>User</span>{<span style=color:#a6e22e>Id</span>: <span style=color:#a6e22e>vars</span>[<span style=color:#e6db74>&#34;id&#34;</span>]}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>curTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Time</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We’ve parsed the request arguments and started a <em>WaitGroup</em> with the value two, as we will do one <em>asynchronous</em> request for each of our services. First we’ll marshal the user struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myUser</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>myUser</span>.<span style=color:#a6e22e>Id</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Problem with parsing the user Id.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>and, then we make a request. Sending the user data, and waiting at most 100 ms for the response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Problem with parsing the user Id.&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;UserNameById&#34;</span>, <span style=color:#a6e22e>data</span>, <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span></code></pre></div><p>now we can check if any error happend, or the response is empty and finish this thread:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;UserNameById&#34;</span>, <span style=color:#a6e22e>data</span>, <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myUserWithName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>User</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myUserWithName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>myUser</span> = <span style=color:#a6e22e>myUserWithName</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>}()
</span></span></code></pre></div><p>Next we’ll do the request to the <em>Time Tellers</em>.<br>We again make a request, but its body is nil, as we don’t need to pass any data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;TimeTeller&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>100</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>receivedTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Time</span>{}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>receivedTime</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>curTime</span> = <span style=color:#a6e22e>receivedTime</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>}()
</span></span></code></pre></div><p>After both requests finished (or failed) we can just respond to the user:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintln</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Hello &#34;</span>, <span style=color:#a6e22e>myUser</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34; with id &#34;</span>, <span style=color:#a6e22e>myUser</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#e6db74>&#34;, the time is &#34;</span>, <span style=color:#a6e22e>curTime</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now if you actually test it, you’ll notice that if one of the provider services isn’t active, the frontend will respond anyways, putting a zero’ed value in place of the non-available resource. You could also make a template that shows an error in that place.</p><p>Ok, that was already an interesting architecture. Now we can implement…</p><h2 id=the-master-slave-pattern>The Master-Slave pattern<a hidden class=anchor aria-hidden=true href=#the-master-slave-pattern>#</a></h2><p>This is such a popular pattern, especially in Go, that we really should know how to implement it. The workers will do simple operations on a text file (count the usage amounts of each word in a comma-separated list).</p><p>Now you could think that the <em>Master</em>, should send the files to the <em>Workers</em> over NATS. Wrong. This would lead to a huge slowdown of NATS (at least for bigger files). That’s why the <em>Master</em> will send the files to a file server over a REST API, and the <em>Workers</em> will get it from there. We’ll also learn how to do <em>service discovery</em> over NATS.</p><p>First, the <em>File Server</em>. I won’t really go through the file handling part, as it’s a simple get/post API.I will however, go over the <em>service discovery</em> part.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/MasterWorker&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>NewRouter</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/{name}&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vars</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Vars</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;/tmp/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>vars</span>[<span style=color:#e6db74>&#34;name&#34;</span>])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>404</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }).<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;GET&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/{name}&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vars</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Vars</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#e6db74>&#34;/tmp/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>vars</span>[<span style=color:#e6db74>&#34;name&#34;</span>])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }).<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;POST&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RunServiceDiscoverable</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:3000&#34;</span>, <span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, what does the <em>RunServiceDiscoverable</em> function do? It connects to the NATS server and responds with its own http address to incoming requests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>RunServiceDiscoverable</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Can&#39;t connect to NATS. Service is not discoverable.&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Discovery.FileServer&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>serviceAddressTransport</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>DiscoverableServiceTransport</span>{<span style=color:#e6db74>&#34;http://localhost:3000&#34;</span>}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>serviceAddressTransport</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Reply</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The proto file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> Transport;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>DiscoverableServiceTransport</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> Address <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We can now go on with the <em>Master</em>.</p><p>The protofile for the <em>Task</em> structure is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> Transport;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Task</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> uuid <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> finisheduuid <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>int32</span> state <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>; <span style=color:#75715e>// 0 - not started, 1 - in progress, 2 - finished
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int32</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Our <em>Master</em> will hold a list of tasks with the respecting <strong>UUID</strong> (at the same time the name of the file), id (the position in the master Tasks slice), and a pointer which holds the position of the last not finished Task, which will get updated on new Task retrieval. It’s pretty similar to the Task storage in my <a href=https://kubamartin.com/2016/03/14/web-app-using-microservices-in-go-part-1-design/>Microservice Architecture series</a></p><p>I’m using <em>github.com/satori/go.uuid</em> for <strong>UUID</strong> generation.</p><p>First, as usual, the basic structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/satori/go.uuid&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/MasterWorker&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Tasks</span> []<span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Task</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>TaskMutex</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>oldestFinishedTaskPointer</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Tasks</span> = make([]<span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Task</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TaskMutex</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>oldestFinishedTaskPointer</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initTestTasks</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Work.TaskToDo&#34;</span>, <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Work.TaskFinished&#34;</span>, <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {} <span style=color:#75715e>// Block forever
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Ok, we’ve also already set up the <em>Subscriptions</em></p><p>How does the <em>initTestTasks</em> function work? It’s interesting because it gets the file server address over NATS.</p><p>So, we want to create 20 test Tasks, so we run the loop 20 times:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>initTestTasks</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>20</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We create a new <em>Task</em> and ask the <em>File Server</em> for its address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>20</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newTask</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Task</span>{<span style=color:#a6e22e>Uuid</span>: <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>NewV4</span>().<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>State</span>: <span style=color:#ae81ff>0</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fileServerAddressTransport</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>DiscoverableServiceTransport</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;Discovery.FileServer&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>fileServerAddressTransport</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fileServerAddress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fileServerAddressTransport</span>.<span style=color:#a6e22e>Address</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next we finally make the post Request to the file server and add the Task to our Tasks list:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>        <span style=color:#a6e22e>fileServerAddress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fileServerAddressTransport</span>.<span style=color:#a6e22e>Address</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#34;get,my,data,my,get,get,have&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#a6e22e>fileServerAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>newTask</span>.<span style=color:#a6e22e>Uuid</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>newTask</span>.<span style=color:#a6e22e>Id</span> = int32(len(<span style=color:#a6e22e>Tasks</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Tasks</span> = append(<span style=color:#a6e22e>Tasks</span>, <span style=color:#a6e22e>newTask</span>)
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>How do we dispatch new Tasks to do? Simply like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Work.TaskToDo&#34;</span>, <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myTaskPointer</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getNextTask</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>myTaskPointer</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Reply</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>How do we get the next Task? We just loop over the Task to find one that is not started. If tasks above our pointer are all finished, then we also move up the pointer. Remember the mutex as this function may be run in parallel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getNextTask</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Task</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TaskMutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>TaskMutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>oldestFinishedTaskPointer</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>Tasks</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>oldestFinishedTaskPointer</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>oldestFinishedTaskPointer</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>State</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>resetTaskIfNotFinished</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>i</span>], <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We also called the <em>resetTaskIfNotFinished</em> function. It will reset the Task state if it’s still in progress after 2 minutes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>resetTaskIfNotFinished</span>(<span style=color:#a6e22e>i</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TaskMutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>State</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>State</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The TaskFinished subscription handler is much simpler, it just sets the Task to finished, and the <strong>UUID</strong> accordingly to the received protobuffer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Work.TaskFinished&#34;</span>, <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myTask</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Task</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myTask</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TaskMutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>myTask</span>.<span style=color:#a6e22e>Id</span>].<span style=color:#a6e22e>State</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Tasks</span>[<span style=color:#a6e22e>myTask</span>.<span style=color:#a6e22e>Id</span>].<span style=color:#a6e22e>Finisheduuid</span> = <span style=color:#a6e22e>myTask</span>.<span style=color:#a6e22e>Finisheduuid</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TaskMutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>That’s all in regards to the <em>Master</em>! We can now move on writing the <em>Worker</em>.</p><p>The basic structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/MasterWorker&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sort&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/satori/go.uuid&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>8</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>doWork</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {} <span style=color:#75715e>// Block forever
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Now the main function doing something here is the <em>doWork</em> function. I’ll post it all at once with comments everywhere, as it’s a very long function and this will be the most convenient way to read it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>doWork</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We ask for a Task with a 1 second Timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;Work.TaskToDo&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We unmarshal the Task
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>curTask</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>Task</span>{}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>curTask</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We get the FileServer address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;Discovery.FileServer&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fileServerAddressTransport</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>DiscoverableServiceTransport</span>{}
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>fileServerAddressTransport</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We get the file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>fileServerAddress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fileServerAddressTransport</span>.<span style=color:#a6e22e>Address</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>fileServerAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>curTask</span>.<span style=color:#a6e22e>Uuid</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We split and count the words
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>words</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(string(<span style=color:#a6e22e>data</span>), <span style=color:#e6db74>&#34;,&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Strings</span>(<span style=color:#a6e22e>words</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wordCounts</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>words</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wordCounts</span>[<span style=color:#a6e22e>words</span>[<span style=color:#a6e22e>i</span>]] = <span style=color:#a6e22e>wordCounts</span>[<span style=color:#a6e22e>words</span>[<span style=color:#a6e22e>i</span>]] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resultData</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>resultData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We print the results to a buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wordCounts</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintln</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>key</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We generate a new UUID for the finished file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>curTask</span>.<span style=color:#a6e22e>Finisheduuid</span> = <span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>NewV4</span>().<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#a6e22e>fileServerAddress</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>curTask</span>.<span style=color:#a6e22e>Finisheduuid</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>StatusCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>StatusCode</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We marshal the current Task into a protobuffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>curTask</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Something went wrong. Waiting 2 seconds before retrying:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We notify the Master about finishing the Task
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;Work.TaskFinished&#34;</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Awesome, our <em>Master-Slave</em> setup is ready, you can test it if you’d like. After you do, we can now check out the last architecture.</p><h2 id=the-events-pattern>The Events pattern<a hidden class=anchor aria-hidden=true href=#the-events-pattern>#</a></h2><p>Imagine you have servers which keep connections to clients over websockets. You want these clients to get live news updates. With this pattern you can. We’ll also learn about a few convenient NATS client abstractions. Like using a encoded connection, or using channels for sending/receiving.</p><p>The basic architecture as usual:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>natsp</span> <span style=color:#e6db74>&#34;github.com/nats-io/nats/encoders/protobuf&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/EventSubs&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ec</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>NewEncodedConn</span>(<span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>natsp</span>.<span style=color:#a6e22e>PROTOBUF_ENCODER</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Wait… What’s that at the end!? It’s an encoded connection! It will automatically encode our structs into raw data. We’ll use the protobuf one, but there are a default one, a gob one and a json one too.</p><p>Here’s the protofile we’ll use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> Transport;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>TextMessage</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>int32</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#66d9ef>string</span> body <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Ok, how can we just publish simple event-structs? Totally intuitive, like that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>5</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myMessage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>{<span style=color:#a6e22e>Id</span>: int32(<span style=color:#a6e22e>i</span>), <span style=color:#a6e22e>Body</span>: <span style=color:#e6db74>&#34;Hello over standard!&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;Messaging.Text.Standard&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myMessage</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It’s a little bit counter intuitive with Requests. As the signature differs, it follows like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#a6e22e>topic</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>body</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>timeout</span>)
</span></span></code></pre></div><p>So our request sending part will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myMessage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>{<span style=color:#a6e22e>Id</span>: int32(<span style=color:#a6e22e>i</span>), <span style=color:#a6e22e>Body</span>: <span style=color:#e6db74>&#34;Hello, please respond!&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#e6db74>&#34;Messaging.Text.Respond&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myMessage</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>200</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#e6db74>&#34; with id &#34;</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The last thing we can do is sending them via Channels, which is relatively the simplest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sendChannel</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>BindSendChan</span>(<span style=color:#e6db74>&#34;Messaging.Text.Channel&#34;</span>, <span style=color:#a6e22e>sendChannel</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>15</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>myMessage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>{<span style=color:#a6e22e>Id</span>: int32(<span style=color:#a6e22e>i</span>), <span style=color:#a6e22e>Body</span>: <span style=color:#e6db74>&#34;Hello over channel!&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendChannel</span> <span style=color:#f92672>&lt;-</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myMessage</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we can write the receiving end. First the same structure as before:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/nats-io/nats&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>natsp</span> <span style=color:#e6db74>&#34;github.com/nats-io/nats/encoders/protobuf&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/cube2222/Blog/NATS/EventSubs&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Wrong number of arguments. Need NATS server address.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ec</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>NewEncodedConn</span>(<span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>natsp</span>.<span style=color:#a6e22e>PROTOBUF_ENCODER</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, first the standard receive which is totally natural:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Messaging.Text.Standard&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Got standard message: \&#34;&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#e6db74>&#34;\&#34; with the Id &#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>Now, the responding, which has a little bit changed syntax again. As the handler function is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>subject</span>, <span style=color:#a6e22e>reply</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>)
</span></span></code></pre></div><p>So the responding looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Subscribe</span>(<span style=color:#e6db74>&#34;Messaging.Text.Respond&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>subject</span>, <span style=color:#a6e22e>reply</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Got ask for response message: \&#34;&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#e6db74>&#34;\&#34; with the Id &#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newMessage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>{<span style=color:#a6e22e>Id</span>: <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#a6e22e>Body</span>: <span style=color:#e6db74>&#34;Responding!&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#a6e22e>reply</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>newMessage</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>And finally using channels, which doesn’t differ nearly at all in comparison to the sending side:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>receiveChannel</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Transport</span>.<span style=color:#a6e22e>TextMessage</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ec</span>.<span style=color:#a6e22e>BindRecvChan</span>(<span style=color:#e6db74>&#34;Messaging.Text.Channel&#34;</span>, <span style=color:#a6e22e>receiveChannel</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>receiveChannel</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Got channel&#39;ed message: \&#34;&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#e6db74>&#34;\&#34; with the Id &#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, that’s all in the topic of NATS. I hope you liked it and discovered something new! Please comment if you have any opinions, or don’t like something, or just want me to write about something.</p><p>Now go and build something great!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kubamartin.com/tags/event/>Event</a></li><li><a href=https://kubamartin.com/tags/go/>Go</a></li><li><a href=https://kubamartin.com/tags/golang/>Golang</a></li><li><a href=https://kubamartin.com/tags/master/>Master</a></li><li><a href=https://kubamartin.com/tags/message/>Message</a></li><li><a href=https://kubamartin.com/tags/microservice/>Microservice</a></li><li><a href=https://kubamartin.com/tags/nats/>NATS</a></li><li><a href=https://kubamartin.com/tags/pattern/>Pattern</a></li><li><a href=https://kubamartin.com/tags/protobuf/>Protobuf</a></li><li><a href=https://kubamartin.com/tags/pub/>Pub</a></li><li><a href=https://kubamartin.com/tags/slave/>Slave</a></li><li><a href=https://kubamartin.com/tags/sub/>Sub</a></li><li><a href=https://kubamartin.com/tags/subscribe/>Subscribe</a></li><li><a href=https://kubamartin.com/tags/worker/>Worker</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on x" href="https://x.com/intent/tweet/?text=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns&amp;url=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f&amp;hashtags=event%2cgo%2cgolang%2cmaster%2cmessage%2cmicroservice%2cNATS%2cpattern%2cprotobuf%2cpub%2cslave%2csub%2csubscribe%2cworker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f&amp;title=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns&amp;summary=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns&amp;source=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f&title=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on whatsapp" href="https://api.whatsapp.com/send?text=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns%20-%20https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on telegram" href="https://telegram.me/share/url?text=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns&amp;url=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Practical Golang: Getting started with NATS and related patterns on ycombinator" href="https://news.ycombinator.com/submitlink?t=Practical%20Golang%3a%20Getting%20started%20with%20NATS%20and%20related%20patterns&u=https%3a%2f%2fkubamartin.com%2f2016%2f06%2f06%2fpractical-golang-getting-started-with-nats-and-related-patterns%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://kubamartin.com/>Jacob Martin</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>